# NOTE: This test-kitchen file contains ERB code to cut-down on boilerplate; YAML
# linters will complain!
# yamllint disable
<%
require 'open3'
require 'json'

# Fall back to current time and known location for report files if not present
# in ENV
report_dir = ENV['REPORT_DIR'] || 'test/reports'
report_ts = ENV['REPORT_TS'] || Time.now.strftime('%Y-%m-%d-%H-%M-%S')

# Parse out the SSH key private file
tf_output, rc = Open3.capture2('terraform -chdir=test/setup output -json')
if rc != 0
  abort 'Failed to capture Terraform output from test/setup'
end
harness_outputs = JSON.parse(tf_output).map { |k,v| [k, v['value']] }.to_h
%>
---
driver:
  name: terraform
  command_timeout: 120
  verify_version: true
  variable_files:
    # This file will be generated by test/setup Terraform
    # NOTE: values in this file will override the 'variables:' section everywhere
    - <%= harness_outputs['harness_tfvars'] %>

provisioner:
  name: terraform

verifier:
  name: terraform
  color: true

platforms:
  - name: local

suites:
  - name: github-minimal
    driver:
      root_module_directory: test/fixtures/github
      variables:
        name: github-minimal
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-push
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/github-minimal.txt
  - name: github-full-push
    driver:
      root_module_directory: test/fixtures/github
      variables:
        name: github-full-push
        description: 'A test GitHub push trigger with all the options'
        filename: "github-full-push.yml"
        disabled: 'true'
        service_account: <%= harness_outputs['sa'] %>
        tags: '[\"github\", \"full\", \"push\"]'
        ignored_files: '[\"github-full-push.tfvars*\", \"**/*tmp\"]'
        included_files: '[\"**/github-full-push.tf\"]'
        substitutions: '{_GITHUB_FULL_PUSH_0 = \"github\", _GITHUB_FULL_PUSH_1=\"full\", _GITHUB_FULL_PUSH_2=\"push\"}'
        dir: github/full/push
        invert_regex: 'true'
        trigger_config: '{is_pr_trigger = false, branch_regex = null, tag_regex = \"github-full-push.*\", comment_control = null}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-push
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/github-full-push.txt
  - name: github-branch-push
    driver:
      root_module_directory: test/fixtures/github
      variables:
        name: github-branch-push
        description: 'A test GitHub push trigger on branch changes'
        filename: "github-branch-push.yml"
        trigger_config: '{is_pr_trigger = false, branch_regex = \"github-branch-push.*\", tag_regex = null, comment_control = null}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-push
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/github-branch-push.txt
  - name: github-full-pr
    driver:
      root_module_directory: test/fixtures/github
      variables:
        name: github-full-pr
        description: 'A test GitHub PR trigger with all the options'
        filename: "github-full-pr.yml"
        disabled: 'false'
        service_account: <%= harness_outputs['sa'] %>
        tags: '[\"github\", \"full\", \"pr\"]'
        ignored_files: '[\"github-full-pr.tfvars*\", \"**/*tmp\"]'
        included_files: '[\"**/github-full-pr.tf\"]'
        substitutions: '{_GITHUB_FULL_PR_0 = \"github\", _GITHUB_FULL_PR_1=\"full\", _GITHUB_FULL_PR_2 = \"pr\"}'
        dir: github/full/pr
        invert_regex: 'true'
        trigger_config: '{is_pr_trigger = true, branch_regex = \"github-full-pr.*\", tag_regex = null, comment_control = \"COMMENTS_DISABLED\"}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-pr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/github-full-pr.txt
  - name: github-pr-comments-enabled
    driver:
      root_module_directory: test/fixtures/github
      variables:
        name: github-pr-comments-enabled
        description: 'A test GitHub PR trigger with comment control enabled'
        filename: "github-pr-comments-enabled.yml"
        trigger_config: '{is_pr_trigger = true, branch_regex = \"github-pr-comments-enabled.*\", tag_regex = null, comment_control = \"COMMENTS_ENABLED\"}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-pr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/github-pr-comments-enabled.txt
  - name: gsr-minimal
    driver:
      root_module_directory: test/fixtures/google-source-repo
      variables:
        name: gsr-minimal
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - gsr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/gsr-minimal.txt
  - name: gsr-full
    driver:
      root_module_directory: test/fixtures/google-source-repo
      variables:
        name: gsr-full
        description: A test Cloud Build trigger for GSR
        filename: "gsr-full.yml"
        disabled: 'true'
        service_account: <%= harness_outputs['sa'] %>
        tags: '[\"gsr\", \"full\"]'
        ignored_files: '[\"gsr-full.tfvars*\", \"**/*tmp\"]'
        included_files: '[\"**/gsr-full.tf\"]'
        substitutions: '{_GSR_FULL_0 = \"github\", _GSR_FULL_1=\"full\"}'
        dir: gsr/full
        invert_regex: 'true'
        trigger_config: '{branch_regex = \"gsr-full.*\", tag_regex = null}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - gsr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/gsr-full.txt
  - name: gsr-tag
    driver:
      root_module_directory: test/fixtures/google-source-repo
      variables:
        name: gsr-tag
        description: A test Cloud Build trigger for GSR on tag
        trigger_config: '{branch_regex = \"\", tag_regex = \"gsr-tag.*\"}'
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - gsr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/gsr-tag.txt
  - name: example-github-branch
    driver:
      root_module_directory: test/fixtures/examples/github-branch
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-push
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/example-github-branch.txt
  - name: example-github-pr
    driver:
      root_module_directory: test/fixtures/examples/github-pr
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-pr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/example-github-pr.txt
  - name: example-github-tag
    driver:
      root_module_directory: test/fixtures/examples/github-tag
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - github-push
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/example-github-tag.txt
  - name: example-gsr-branch
    driver:
      root_module_directory: test/fixtures/examples/gsr-branch
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - gsr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/example-gsr-branch.txt
  - name: example-gsr-tag
    driver:
      root_module_directory: test/fixtures/examples/gsr-tag
    verifier:
      systems:
        - name: cloudbuild-trigger
          backend: gcp
          profile_locations:
            - test/profiles/cloudbuild-trigger
          controls:
            - cloudbuild-common
            - cloudbuild-filename
            - gsr
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/example-gsr-tag.txt
